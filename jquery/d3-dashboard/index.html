<!DOCTYPE html>
<html>
    <meta charset="utf-8">

    <head>
        <link rel="stylesheet" type="text/css" href="css/external/animate.css">

        <!-- app styles -->
        <style>
            html {
                height:100%;
                overflow:hidden;
            }

            body {
                color: #bbb;
                font-family: "Source Sans Pro",Calibri,Candara,Arial,sans-serif;
                font-size: 12px;
                font-weight: 400;
                width: 960px;
                height: 100%;
                position: relative;
                margin: auto;

                /* Permalink - use to edit and share this gradient: http://colorzilla.com/gradient-editor/#222222+1,353535+51,333333+100 */
                background: #222222; /* Old browsers */
                background: -moz-linear-gradient(top, #222222 1%, #353535 51%, #333333 100%); /* FF3.6-15 */
                background: -webkit-linear-gradient(top, #222222 1%,#353535 51%,#333333 100%); /* Chrome10-25,Safari5.1-6 */
                background: linear-gradient(to bottom, #222222 1%,#353535 51%,#333333 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
                filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#222222', endColorstr='#333333',GradientType=0 ); /* IE6-9 */
            }

            #panel-parent {
                position:relative;
                z-index:1;
                top:35px;
            }

            #panel-parent.center {
            }

            #panel-a {}
            #panel-b {
                top:-38px;
                left:330px;
            }

            #panel-c {
                top:-420px;
                left:543px;
            }

            #panel-b:hover, #panel-c:hover {
                background-position:0 -269px;
            }

            .panel {
                background: transparent url(img/hex-sprite.png) no-repeat scroll 0 0;
                width:300px;
                height:260px;
                background-size:cover;
                position: relative;
                z-index:1;
                top:100px;
                left:117px;
                cursor:pointer;
            }

            .panel span {
                display:block;
                position: relative;
                top:54px;
                left:83px;
                font-size:24px;
                width:157px;
            }

            .panel span + span {
                margin-top:10px;
            }

            #panel-a.grow {
                width:600px;
                height:500px;
            }

            .panel-bg {
                opacity:0;
                background-color:#ff7;
                width:800px;
                height:600px;
                margin:auto;
                position:absolute;
                top:0;
                left:0;
                box-shadow: 10px 5px 5px black;
                border:1px solid #000;
            }

            .panel-bg.active {
                opacity: 0.1
            }

            #panel-widget {
                opacity:0;
                background-color:transparent;
                width:800px;
                height:600px;
                margin:auto;
                position:absolute;
                top:0;
                left:0;
            }

            #panel-widget.active {
                opacity: 1
            }

            .panel.hover {
                background-position:0 -269px;
            }

            .transition {
                /*-webkit-transition: width 1s, height 1s, left 5s, -webkit-transform 5s;*/
                transition: all 1s;
                transition-property: width , height , margin-left, opacity;
                /*transition-duration: 1s, 1s, 2s;*/
            }

            .finished {
                opacity:0;
                z-index:-1 !important;
            }

            .close {
                background:transparent url(img/close-icon.png) no-repeat scroll 0 0;
                width:24px;
                height:24px;
                background-size:cover;
                float:right;
                margin-top:10px;
                margin-right:10px;
                cursor:pointer;
            }
        </style>

        <!-- gears -->
        <style>
            h1 {
                text-align:center;
            }

            form {
                display:none;
                position: absolute;
                top: 1em;
                left: 1em;
            }

            #gears {
                position: absolute;
                top:75px;
                left:0;
                opacity:0.03;
                z-index:0;
            }

            path {
                fill-rule: evenodd;
                stroke: #222;
                stroke-width: 2px;
            }

            .sun path {
                fill: #222;
            }

            .planet path {
                fill: #222;
            }

            .annulus path {
                fill: #222;
            }

        </style>

        <!-- voronoi diagram -->
        <style type="text/css">
            #chart {
                display:none;
            }

            #voronoi {
                display:block;
                margin:auto;
                position:relative;
                z-index:1;
            }

            circle {
                stroke: #EFEDF5;
                fill: #EFEDF5;
                pointer-events: none;
            }
            line {
                pointer-events: none;
                stroke: #EFEDF5;
                stroke-width: 2px;
                opacity: .05;
            }
            path{
                stroke: #EFEDF5;
                stroke-width: 4px;
            }
        </style>

        <!-- sequence chart -->
        <style type="text/css">
            #main {
                float: left;
                width: 690px;
            }

            #sidebar {
                font-size:15px;
                margin-top:284px;
                float: right;
                width: 100px;
            }

            #togglelegend {
                position:relative;
                top:3px;
            }

            #sequence {
                width: 600px;
                height: 70px;
                color:#fff;
            }

            #legend {
                padding: 10px 0 0 3px;
            }

            #sequence text, #legend text {
                font-weight: 600;
                fill: #fff;
            }

            #seq-chart {
                position: relative;
            }

            #seq-chart path {
                stroke: #ddd;
                stroke-width:1px;
            }

            #explanation {
                position: absolute;
                top: 182px;
                left: 307px;
                width: 140px;
                text-align: center;
                color: #fff;
                z-index: 0;
            }

            #percentage {
                font-size: 2.5em;
            }            
        </style>
    </head>

    <body>
        <h1 style="top:25px; position:relative;">Mock Dashboard</h1>
        <form>
            <input type="radio" name="reference" id="ref-annulus">
            <label for="ref-annulus">Annulus</label><br>
            <input type="radio" name="reference" id="ref-planet" checked>
            <label for="ref-planet">Planets</label><br>
            <input type="radio" name="reference" id="ref-sun">
            <label for="ref-sun">Sun</label>
        </form>

        <div id="chart">
        </div>

        <div id="panel-parent">
            <div>
                <div id="panel-a" class="panel transition">
                    <div class="text">
                        <span style="top:47px; left:55px; text-align:center; width:194px;">
                            Sequence Data Widget
                        </span>
                        <span style="left:57px;">
                            Overview:
                            <ul style="font-size:12px; margin-top:5px;">
                                <li>100% sample rate</li>
                                <li>32k pages tracked</li>
                                <li>last update: 3h ago</li>
                            </ul>
                        </span>
                        <span style="font-size:11px; top:63px; left:109px;">Click for more info</span>
                    </div>
                </div>
                <div class="panel-bg transition"></div>
                <div id="panel-widget" class="transition">
                    <span>

                    </span>
                    <div id="main">
                        <div id="sequence"></div>
                        <div id="seq-chart">
                            <div id="explanation" style="visibility: hidden;">
                                <span id="percentage"></span><br/>
                                of visits begin with this sequence of pages
                            </div>
                        </div>
                    </div>
                    <div class="close"></div>
                    <div id="sidebar">
                        <input type="checkbox" id="togglelegend"> Legend<br/>
                        <div id="legend" style="visibility: hidden;"></div>
                    </div>
                </div>
            </div>
            <div>
                <div id="panel-b" class="panel transition">
                    <span style="left:107px;">
                        Example Widget B
                    </span>
                </div>
            </div>
            <div>
                <div id="panel-c" class="panel transition">
                    <span style="left:107px;">
                        Example Widget C
                    </span>
                </div>
            </div>
        </div>

        <script src="js/external/jquery.min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <!--<script src="js/external/d3.v4.min.js"></script>-->

        <!-- global script -->
        <script type="text/javascript">
            function animateCssCurried (animatePropAry, completeFn) {
                let aryCopy = [].concat(animatePropAry);
                
                return function (animationName) {
                    var animationEnd = 'webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend';
                    this.addClass('animated ' + animationName).one(animationEnd, function() {
                        $(this).removeClass('animated ' + animationName);

                        if (aryCopy && Array.isArray(aryCopy) && aryCopy.length === 1) {
                            if (completeFn && typeof completeFn === "function") {
                                completeFn(false);
                            }
                        }

                        if (aryCopy && Array.isArray(aryCopy) && aryCopy.length > 0) {
                            $(this).animateCss(aryCopy.shift());
                        } else {
                            if (completeFn && typeof completeFn === "function") {
                                completeFn(true);
                            }
                        }
                    });
                }
            }

            $(".close").click(function () {
                $(".panel-bg").addClass("finished")
                        .removeClass("active");
                $("#panel-widget").addClass("finished")
                        .removeClass("active");

                $("#panel-a").removeClass("finished grow")
                    .css({"margin-left": "0"})
                    .mouseenter(function () {
                        $(this).addClass("hover");
                    })
                    .mouseleave(function () {
                        $(this).removeClass("hover");
                    })
                    .find(".text").show();

                $("#panel-b, #panel-c").show();

                init();
            });
        </script>

        <!-- hexagon script -->
        <script type="text/javascript">
            let animatePropAry = [
                    "fadeOut"
                ];

            function init () {
                $.fn.extend({
                    animateCss: animateCssCurried(animatePropAry, (isDoneProcessing) => {
//                    setTimeout(() => {}, 0);
                        if (isDoneProcessing) {
                            $("#panel-a").addClass("finished");
                        } else {
                            $(".panel-bg").removeClass("finished")
                                    .addClass("active")
                                    .css({
                                        "left": $("#panel-widget").parent().width() / 2 - $("#panel-widget").width() / 2
                                    });

                            $("#panel-widget").removeClass("finished")
                                    .addClass("active")
                                    .css({
                                        "left": $("#panel-widget").parent().width() / 2 - $("#panel-widget").width() / 2
                                    });
                        }
                    })
                });
            }

            init();

            $("#panel-a").mouseenter(function () {
              $(this).addClass("hover");
            }).mouseleave(function () {
                $(this).removeClass("hover");
            }).click(function () {
                let newWidth = 600
                    , newHeight = 500;

                $("#panel-b, #panel-c").hide();
                $(this).find(".text").hide();
                $(this).removeClass("hover");
                $(this).mouseenter(function () {
                    $(this).removeClass("hover");
                });

                $(this).addClass("grow fadeOut");
                $(this).animateCss("flip");
                $(this).css({"margin-left": (($(this).parent().width()/2) - (newWidth/2) - $(this).position().left) + "px"});
                setTimeout(() => {
//                    $(this).width(newWidth);
//                    $(this).height(newHeight);
                }, 0)
            });
        </script>

        <!-- gears script -->
        <script>
            var width = 960,
                    height = 700,
                    radius = 120,
                    x = Math.sin(2 * Math.PI / 3),
                    y = Math.cos(2 * Math.PI / 3);

            var offset = 0,
                    speed = 4,
                    start = Date.now();

            var svg = d3.select("body").append("svg")
                    .attr("id", "gears")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(.55)")
                    .append("g");

            var frame = svg.append("g")
                    .datum({radius: Infinity});

            frame.append("g")
                    .attr("class", "annulus")
                    .datum({teeth: 80, radius: -radius * 5, annulus: true})
                    .append("path")
                    .attr("d", gear);

            frame.append("g")
                    .attr("class", "sun")
                    .datum({teeth: 16, radius: radius})
                    .append("path")
                    .attr("d", gear);

            frame.append("g")
                    .attr("class", "planet")
                    .attr("transform", "translate(0,-" + radius * 3 + ")")
                    .datum({teeth: 32, radius: -radius * 2})
                    .append("path")
                    .attr("d", gear);

            frame.append("g")
                    .attr("class", "planet")
                    .attr("transform", "translate(" + -radius * 3 * x + "," + -radius * 3 * y + ")")
                    .datum({teeth: 32, radius: -radius * 2})
                    .append("path")
                    .attr("d", gear);

            frame.append("g")
                    .attr("class", "planet")
                    .attr("transform", "translate(" + radius * 3 * x + "," + -radius * 3 * y + ")")
                    .datum({teeth: 32, radius: -radius * 2})
                    .append("path")
                    .attr("d", gear);

            d3.selectAll("input[name=reference]")
                    .data([radius * 5, Infinity, -radius])
                    .on("change", function(radius1) {
                        var radius0 = frame.datum().radius, angle = (Date.now() - start) * speed;
                        frame.datum({radius: radius1});
                        svg.attr("transform", "rotate(" + (offset += angle / radius0 - angle / radius1) + ")");
                    });

            d3.selectAll("input[name=speed]")
                    .on("change", function() { speed = +this.value; });

            function gear(d) {
                var n = d.teeth,
                        r2 = Math.abs(d.radius),
                        r0 = r2 - 8,
                        r1 = r2 + 8,
                        r3 = d.annulus ? (r3 = r0, r0 = r1, r1 = r3, r2 + 20) : 20,
                        da = Math.PI / n,
                        a0 = -Math.PI / 2 + (d.annulus ? Math.PI / n : 0),
                        i = -1,
                        path = ["M", r0 * Math.cos(a0), ",", r0 * Math.sin(a0)];
                while (++i < n) path.push(
                        "A", r0, ",", r0, " 0 0,1 ", r0 * Math.cos(a0 += da), ",", r0 * Math.sin(a0),
                        "L", r2 * Math.cos(a0), ",", r2 * Math.sin(a0),
                        "L", r1 * Math.cos(a0 += da / 3), ",", r1 * Math.sin(a0),
                        "A", r1, ",", r1, " 0 0,1 ", r1 * Math.cos(a0 += da / 3), ",", r1 * Math.sin(a0),
                        "L", r2 * Math.cos(a0 += da / 3), ",", r2 * Math.sin(a0),
                        "L", r0 * Math.cos(a0), ",", r0 * Math.sin(a0));
                path.push("M0,", -r3, "A", r3, ",", r3, " 0 0,0 0,", r3, "A", r3, ",", r3, " 0 0,0 0,", -r3, "Z");
                return path.join("");
            }

            d3.timer(function() {
                var angle = (Date.now() - start) * speed,
                        transform = function(d) { return "rotate(" + angle / d.radius + ")"; };
                frame.selectAll("path").attr("transform", transform);
                frame.attr("transform", transform); // frame of reference
            });

        </script>

        <!-- voronoi script -->
        <script type="text/javascript">
            var w = window.innerWidth > 960 ? 960 : (window.innerWidth || 960),
                    h = window.innerHeight > 500 ? 500 : (window.innerHeight || 500),
                    radius = 5.25,
                    links = [],
                    simulate = true,
                    zoomToAdd = true,
                    // https://github.com/mbostock/d3/blob/master/lib/colorbrewer/colorbrewer.js#L105
                    color = d3.scale.quantize().domain([10000, 7250]).range(["#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"])
            var numVertices = (w*h) / 3000;
            var vertices = d3.range(numVertices).map(function(i) {
                angle = radius * (i+10);
                return {x: angle*Math.cos(angle)+(w/2), y: angle*Math.sin(angle)+(h/2)};
            });
            var d3_geom_voronoi = d3.geom.voronoi().x(function(d) { return d.x; }).y(function(d) { return d.y; })
            var prevEventScale = 1;
            var zoom = d3.behavior.zoom().on("zoom", function(d,i) {
                if (zoomToAdd){
                    if (d3.event.scale > prevEventScale) {
                        angle = radius * vertices.length;
                        vertices.push({x: angle*Math.cos(angle)+(w/2), y: angle*Math.sin(angle)+(h/2)})
                    } else if (vertices.length > 2 && d3.event.scale != prevEventScale) {
                        vertices.pop();
                    }
                    force.nodes(vertices).start()
                } else {
                    if (d3.event.scale > prevEventScale) {
                        radius+= .01
                    } else {
                        radius -= .01
                    }
                    vertices.forEach(function(d, i) {
                        angle = radius * (i+10);
                        vertices[i] = {x: angle*Math.cos(angle)+(w/2), y: angle*Math.sin(angle)+(h/2)};
                    });
                    force.nodes(vertices).start()
                }
                prevEventScale = d3.event.scale;
            });
            d3.select(window)
                    .on("keydown", function() {
                        // shift
                        if(d3.event.keyCode == 16) {
                            zoomToAdd = false
                        }
                        // s
                        if(d3.event.keyCode == 83) {
                            simulate = !simulate
                            if(simulate) {
                                force.start()
                            } else {
                                force.stop()
                            }
                        }
                    })
                    .on("keyup", function() {
                        zoomToAdd = true
                    })
            var svg = d3.select("#chart")
                    .append("svg")
                    .attr("id", "voronoi")
                    .attr("width", w)
                    .attr("height", h)
                    .call(zoom)
            var force = d3.layout.force()
                    .charge(-300)
                    .size([w, h])
                    .on("tick", update);
            force.nodes(vertices).start();
            var circle = svg.selectAll("circle");
            var path = svg.selectAll("path");
            var link = svg.selectAll("line");
            function update(e) {
                path = path.data(d3_geom_voronoi(vertices))
                path.enter().append("path")
                // drag node by dragging cell
                        .call(d3.behavior.drag()
                                .on("drag", function(d, i) {
                                    vertices[i] = {x: vertices[i].x + d3.event.dx, y: vertices[i].y + d3.event.dy}
                                })
                        )
                        .style("fill", function(d, i) { return color(0) })
                path.attr("d", function(d) { return "M" + d.join("L") + "Z"; })
                        .transition().duration(150).style("fill", function(d, i) { return color(d3.geom.polygon(d).area()) })
                path.exit().remove();
                circle = circle.data(vertices)
                circle.enter().append("circle")
                        .attr("r", 0)
                        .transition().duration(1000).attr("r", 5);
                circle.attr("cx", function(d) { return d.x; })
                        .attr("cy", function(d) { return d.y; });
                circle.exit().transition().attr("r", 0).remove();
                link = link.data(d3_geom_voronoi.links(vertices))
                link.enter().append("line")
                link.attr("x1", function(d) { return d.source.x; })
                        .attr("y1", function(d) { return d.source.y; })
                        .attr("x2", function(d) { return d.target.x; })
                        .attr("y2", function(d) { return d.target.y; })
                link.exit().remove()
                if(!simulate) force.stop()
            }
        </script>

        <!-- sequences script -->
        <script type="text/javascript">
            // Dimensions of sunburst.
            var width = 750;
            var height = 450;
            var radius = Math.min(width, height) / 2;

            // Breadcrumb dimensions: width, height, spacing, width of tip/tail.
            var b = {
                w: 75, h: 30, s: 3, t: 10
            };

            // Mapping of step names to colors.
            var colors = {
                "home": "#5687d1",
                "product": "#7b615c",
                "search": "#de783b",
                "account": "#6ab975",
                "other": "#a173d1",
                "end": "#bbbbbb"
            };

            // Total size of all segments; we set this later, after loading the data.
            var totalSize = 0;

            var vis = d3.select("#seq-chart").append("svg:svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("svg:g")
                    .attr("id", "container")
                    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            var partition = d3.layout.partition()
                    .size([2 * Math.PI, radius * radius])
                    .value(function(d) { return d.size; });

            var arc = d3.svg.arc()
                    .startAngle(function(d) { return d.x; })
                    .endAngle(function(d) { return d.x + d.dx; })
                    .innerRadius(function(d) { return Math.sqrt(d.y); })
                    .outerRadius(function(d) { return Math.sqrt(d.y + d.dy); });

            // Use d3.text and d3.csv.parseRows so that we do not need to have a header
            // row, and can receive the csv as an array of arrays.
            d3.text("visit-sequences.csv", function(text) {
                var csv = d3.csv.parseRows(text);
                var json = buildHierarchy(csv);
                createVisualization(json);
            });

            // Main function to draw and set up the visualization, once we have the data.
            function createVisualization(json) {

                // Basic setup of page elements.
                initializeBreadcrumbTrail();
                drawLegend();
                d3.select("#togglelegend").on("click", toggleLegend);

                // Bounding circle underneath the sunburst, to make it easier to detect
                // when the mouse leaves the parent g.
                vis.append("svg:circle")
                        .attr("r", radius)
                        .style("opacity", 0);

                // For efficiency, filter nodes to keep only those large enough to see.
                var nodes = partition.nodes(json)
                        .filter(function(d) {
                            return (d.dx > 0.005); // 0.005 radians = 0.29 degrees
                        });

                var path = vis.data([json]).selectAll("path")
                        .data(nodes)
                        .enter().append("svg:path")
                        .attr("display", function(d) { return d.depth ? null : "none"; })
                        .attr("d", arc)
                        .attr("fill-rule", "evenodd")
                        .style("fill", function(d) { return colors[d.name]; })
                        .style("opacity", 1)
                        .on("mouseover", mouseover);

                // Add the mouseleave handler to the bounding circle.
                d3.select("#container").on("mouseleave", mouseleave);

                // Get total size of the tree = value of root node from partition.
                totalSize = path.node().__data__.value;
            }

            // Fade all but the current sequence, and show it in the breadcrumb trail.
            function mouseover(d) {

                var percentage = (100 * d.value / totalSize).toPrecision(3);
                var percentageString = percentage + "%";
                if (percentage < 0.1) {
                    percentageString = "< 0.1%";
                }

                d3.select("#percentage")
                        .text(percentageString);

                d3.select("#explanation")
                        .style("visibility", "");

                var sequenceArray = getAncestors(d);
                updateBreadcrumbs(sequenceArray, percentageString);

                // Fade all the segments.
                d3.selectAll("path")
                        .style("opacity", 0.3);

                // Then highlight only those that are an ancestor of the current segment.
                vis.selectAll("path")
                        .filter(function(node) {
                            return (sequenceArray.indexOf(node) >= 0);
                        })
                        .style("opacity", 1);
            }

            // Restore everything to full opacity when moving off the visualization.
            function mouseleave(d) {

                // Hide the breadcrumb trail
                d3.select("#trail")
                        .style("visibility", "hidden");

                // Deactivate all segments during transition.
                d3.selectAll("path").on("mouseover", null);

                // Transition each segment to full opacity and then reactivate it.
                d3.selectAll("path")
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)
                        .each("end", function() {
                            d3.select(this).on("mouseover", mouseover);
                        });

                d3.select("#explanation")
                        .style("visibility", "hidden");
            }

            // Given a node in a partition layout, return an array of all of its ancestor
            // nodes, highest first, but excluding the root.
            function getAncestors(node) {
                var path = [];
                var current = node;
                while (current.parent) {
                    path.unshift(current);
                    current = current.parent;
                }
                return path;
            }

            function initializeBreadcrumbTrail() {
                // Add the svg area.
                var trail = d3.select("#sequence").append("svg:svg")
                        .attr("width", width)
                        .attr("height", 50)
                        .attr("id", "trail");
                // Add the label at the end, for the percentage.
                trail.append("svg:text")
                        .attr("id", "endlabel")
                        .style("fill", "#000");
            }

            // Generate a string that describes the points of a breadcrumb polygon.
            function breadcrumbPoints(d, i) {
                var points = [];
                points.push("0,0");
                points.push(b.w + ",0");
                points.push(b.w + b.t + "," + (b.h / 2));
                points.push(b.w + "," + b.h);
                points.push("0," + b.h);
                if (i > 0) { // Leftmost breadcrumb; don't include 6th vertex.
                    points.push(b.t + "," + (b.h / 2));
                }
                return points.join(" ");
            }

            // Update the breadcrumb trail to show the current sequence and percentage.
            function updateBreadcrumbs(nodeArray, percentageString) {

                // Data join; key function combines name and depth (= position in sequence).
                var g = d3.select("#trail")
                        .selectAll("g")
                        .data(nodeArray, function(d) { return d.name + d.depth; });

                // Add breadcrumb and label for entering nodes.
                var entering = g.enter().append("svg:g");

                entering.append("svg:polygon")
                        .attr("points", breadcrumbPoints)
                        .style("fill", function(d) { return colors[d.name]; });

                entering.append("svg:text")
                        .attr("x", (b.w + b.t) / 2)
                        .attr("y", b.h / 2)
                        .attr("dy", "0.35em")
                        .attr("text-anchor", "middle")
                        .text(function(d) { return d.name; });

                // Set position for entering and updating nodes.
                g.attr("transform", function(d, i) {
                    return "translate(" + i * (b.w + b.s) + ", 0)";
                });

                // Remove exiting nodes.
                g.exit().remove();

                // Now move and update the percentage at the end.
                d3.select("#trail").select("#endlabel")
                        .attr("x", (nodeArray.length + 0.5) * (b.w + b.s))
                        .attr("y", b.h / 2)
                        .attr("dy", "0.35em")
                        .attr("text-anchor", "middle")
                        .text(percentageString);

                // Make the breadcrumb trail visible, if it's hidden.
                d3.select("#trail")
                        .style("visibility", "");

            }

            function drawLegend() {

                // Dimensions of legend item: width, height, spacing, radius of rounded rect.
                var li = {
                    w: 75, h: 30, s: 3, r: 3
                };

                var legend = d3.select("#legend").append("svg:svg")
                        .attr("width", li.w)
                        .attr("height", d3.keys(colors).length * (li.h + li.s));

                var g = legend.selectAll("g")
                        .data(d3.entries(colors))
                        .enter().append("svg:g")
                        .attr("transform", function(d, i) {
                            return "translate(0," + i * (li.h + li.s) + ")";
                        });

                g.append("svg:rect")
                        .attr("rx", li.r)
                        .attr("ry", li.r)
                        .attr("width", li.w)
                        .attr("height", li.h)
                        .style("fill", function(d) { return d.value; });

                g.append("svg:text")
                        .attr("x", li.w / 2)
                        .attr("y", li.h / 2)
                        .attr("dy", "0.35em")
                        .attr("text-anchor", "middle")
                        .text(function(d) { return d.key; });
            }

            function toggleLegend() {
                var legend = d3.select("#legend");
                if (legend.style("visibility") == "hidden") {
                    legend.style("visibility", "");
                } else {
                    legend.style("visibility", "hidden");
                }
            }

            // Take a 2-column CSV and transform it into a hierarchical structure suitable
            // for a partition layout. The first column is a sequence of step names, from
            // root to leaf, separated by hyphens. The second column is a count of how
            // often that sequence occurred.
            function buildHierarchy(csv) {
                var root = {"name": "root", "children": []};
                for (var i = 0; i < csv.length; i++) {
                    var sequence = csv[i][0];
                    var size = +csv[i][1];
                    if (isNaN(size)) { // e.g. if this is a header row
                        continue;
                    }
                    var parts = sequence.split("-");
                    var currentNode = root;
                    for (var j = 0; j < parts.length; j++) {
                        var children = currentNode["children"];
                        var nodeName = parts[j];
                        var childNode;
                        if (j + 1 < parts.length) {
                            // Not yet at the end of the sequence; move down the tree.
                            var foundChild = false;
                            for (var k = 0; k < children.length; k++) {
                                if (children[k]["name"] == nodeName) {
                                    childNode = children[k];
                                    foundChild = true;
                                    break;
                                }
                            }
                            // If we don't already have a child node for this branch, create it.
                            if (!foundChild) {
                                childNode = {"name": nodeName, "children": []};
                                children.push(childNode);
                            }
                            currentNode = childNode;
                        } else {
                            // Reached the end of the sequence; create a leaf node.
                            childNode = {"name": nodeName, "size": size};
                            children.push(childNode);
                        }
                    }
                }
                return root;
            };
        </script>
    </body>
</html>